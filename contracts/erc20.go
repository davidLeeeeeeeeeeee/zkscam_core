package contracts

import (
	"context"
	"github.com/ethereum/go-ethereum"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/ethereum/go-ethereum/rpc"
	"log"
	"math/big"
	"sync"
)

// ERC20 represents a module for retrieving ERC20 balances
type ERC20 struct {
	Client *rpc.Client
}

// 固定的 ERC20 合约地址 0xc00fbbeb1cc277be7102f8af85bad2c0d0ac1856
// var tokenAddress = common.HexToAddress("0xc00fbbeb1cc277be7102f8af85bad2c0d0ac1856")
// YB
var tokenAddress = common.HexToAddress("0x4b75210419009994c7f856f0b5c5b79750dbed22")

// 硬编码的 RPC URL
const rpcURL = "http://localhost:8545"

//const rpcURL = "http://localhost:8546"

var (
	instance *ERC20
	once     sync.Once
)

// NewERC20 creates or returns the single instance of ERC20
func NewERC20() (*ERC20, error) {
	var err error
	once.Do(func() {
		var client *rpc.Client
		client, err = rpc.DialContext(context.Background(), rpcURL)
		if err != nil {
			log.Printf("Failed to connect to RPC: %v", err)
			return
		}
		instance = &ERC20{Client: client}
	})
	if err != nil {
		return nil, err
	}
	return instance, nil
}

// BalanceOf GetBalance retrieves the balance of the ERC20 token for a specific address
func (erc20 *ERC20) BalanceOf(accountAddress common.Address) (*big.Int, error) {
	client := ethclient.NewClient(erc20.Client)

	// ERC20 balanceOf function signature: 70a08231
	data := append([]byte{0x70, 0xa0, 0x82, 0x31}, common.LeftPadBytes(accountAddress.Bytes(), 32)...)

	callMsg := ethereum.CallMsg{
		To:   &tokenAddress,
		Data: data,
	}

	result, err := client.CallContract(context.Background(), callMsg, nil)
	if err != nil {
		return nil, err
	}

	//fmt.Printf("Raw result from eth_call: %s\n", hex.EncodeToString(result))

	balance := new(big.Int).SetBytes(result)
	return balance, nil
}

// BalanceOfAt retrieves the balance of the ERC20 token for a specific address at a specific block number
func (erc20 *ERC20) BalanceOfAt(accountAddress common.Address, blockNumber *big.Int) (*big.Int, error) {
	// Check if blockNumber is less than 0, and set it to 0 if true
	if blockNumber.Cmp(big.NewInt(0)) < 0 {
		blockNumber = big.NewInt(0)
	}

	client := ethclient.NewClient(erc20.Client)

	// ERC20 balanceOf function signature: 70a08231
	data := append([]byte{0x70, 0xa0, 0x82, 0x31}, common.LeftPadBytes(accountAddress.Bytes(), 32)...)

	callMsg := ethereum.CallMsg{
		To:   &tokenAddress,
		Data: data,
	}

	// Call the contract at the specific block number
	result, err := client.CallContract(context.Background(), callMsg, blockNumber)
	if err != nil {
		log.Printf(blockNumber.String(), accountAddress.String(), err.Error())
		return nil, err
	}

	// fmt.Printf("Raw result from eth_call at block %s: %s\n", blockNumber.String(), hex.EncodeToString(result))

	balance := new(big.Int).SetBytes(result)
	return balance, nil
}

////608060405234801562000010575f80fd5b50336040518060400160405280600b81526020017f4d79546f6b656e4e616d650000000000000000000000000000000000000000008152506040518060400160405280600381526020017f4d544b000000000000000000000000000000000000000000000000000000000081525081600390816200008f91906200074b565b508060049081620000a191906200074b565b5050505f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff160362000117575f6040517f1e4fbdf70000000000000000000000000000000000000000000000000000000081526004016200010e919062000872565b60405180910390fd5b62000128816200016e60201b60201c565b5062000168306200013e6200023160201b60201c565b600a6200014c919062000a16565b620f42406200015c919062000a66565b6200023960201b60201c565b62000b51565b5f60055f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690508160055f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b5f6012905090565b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603620002ac575f6040517fec442f05000000000000000000000000000000000000000000000000000000008152600401620002a3919062000872565b60405180910390fd5b620002bf5f8383620002c360201b60201c565b5050565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160362000317578060025f8282546200030a919062000ab0565b92505081905550620003e8565b5f805f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054905081811015620003a3578381836040517fe450d38c0000000000000000000000000000000000000000000000000000000081526004016200039a9392919062000afb565b60405180910390fd5b8181035f808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2081905550505b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160362000431578060025f82825403925050819055506200047b565b805f808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f82825401925050819055505b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051620004da919062000b36565b60405180910390a3505050565b5f81519050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806200056357607f821691505b6020821081036200057957620005786200051e565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f60088302620005dd7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82620005a0565b620005e98683620005a0565b95508019841693508086168417925050509392505050565b5f819050919050565b5f819050919050565b5f620006336200062d620006278462000601565b6200060a565b62000601565b9050919050565b5f819050919050565b6200064e8362000613565b620006666200065d826200063a565b848454620005ac565b825550505050565b5f90565b6200067c6200066e565b6200068981848462000643565b505050565b5b81811015620006b057620006a45f8262000672565b6001810190506200068f565b5050565b601f821115620006ff57620006c9816200057f565b620006d48462000591565b81016020851015620006e4578190505b620006fc620006f38562000591565b8301826200068e565b50505b505050565b5f82821c905092915050565b5f620007215f198460080262000704565b1980831691505092915050565b5f6200073b838362000710565b9150826002028217905092915050565b6200075682620004e7565b67ffffffffffffffff811115620007725762000771620004f1565b5b6200077e82546200054b565b6200078b828285620006b4565b5f60209050601f831160018114620007c1575f8415620007ac578287015190505b620007b885826200072e565b86555062000827565b601f198416620007d1866200057f565b5f5b82811015620007fa57848901518255600182019150602085019450602081019050620007d3565b868310156200081a578489015162000816601f89168262000710565b8355505b6001600288020188555050505b505050505050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6200085a826200082f565b9050919050565b6200086c816200084e565b82525050565b5f602082019050620008875f83018462000861565b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f8160011c9050919050565b5f808291508390505b60018511156200091757808604811115620008ef57620008ee6200088d565b5b6001851615620008ff5780820291505b80810290506200090f85620008ba565b9450620008cf565b94509492505050565b5f8262000931576001905062000a03565b8162000940575f905062000a03565b816001811462000959576002811462000964576200099a565b600191505062000a03565b60ff8411156200097957620009786200088d565b5b8360020a9150848211156200099357620009926200088d565b5b5062000a03565b5060208310610133831016604e8410600b8410161715620009d45782820a905083811115620009ce57620009cd6200088d565b5b62000a03565b620009e38484846001620008c6565b92509050818404811115620009fd57620009fc6200088d565b5b81810290505b9392505050565b5f60ff82169050919050565b5f62000a228262000601565b915062000a2f8362000a0a565b925062000a5e7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff848462000920565b905092915050565b5f62000a728262000601565b915062000a7f8362000601565b925082820262000a8f8162000601565b9150828204841483151762000aa95762000aa86200088d565b5b5092915050565b5f62000abc8262000601565b915062000ac98362000601565b925082820190508082111562000ae45762000ae36200088d565b5b92915050565b62000af58162000601565b82525050565b5f60608201905062000b105f83018662000861565b62000b1f602083018562000aea565b62000b2e604083018462000aea565b949350505050565b5f60208201905062000b4b5f83018462000aea565b92915050565b6116dc8062000b5f5f395ff3fe608060405234801561000f575f80fd5b50600436106100fe575f3560e01c806373b2e80e116100955780639a114cb2116100645780639a114cb21461029c578063a9059cbb146102b8578063dd62ed3e146102e8578063f2fde38b14610318576100fe565b806373b2e80e146102145780637cb64759146102445780638da5cb5b1461026057806395d89b411461027e576100fe565b80632eb4a7ab116100d15780632eb4a7ab1461019e578063313ce567146101bc57806370a08231146101da578063715018a61461020a576100fe565b806306fdde0314610102578063095ea7b31461012057806318160ddd1461015057806323b872dd1461016e575b5f80fd5b61010a610334565b6040516101179190611039565b60405180910390f35b61013a600480360381019061013591906110ee565b6103c4565b6040516101479190611146565b60405180910390f35b6101586103e6565b604051610165919061116e565b60405180910390f35b61018860048036038101906101839190611187565b6103ef565b6040516101959190611146565b60405180910390f35b6101a661041d565b6040516101b391906111ef565b60405180910390f35b6101c4610423565b6040516101d19190611223565b60405180910390f35b6101f460048036038101906101ef919061123c565b61042b565b604051610201919061116e565b60405180910390f35b610212610470565b005b61022e6004803603810190610229919061123c565b610483565b60405161023b9190611146565b60405180910390f35b61025e60048036038101906102599190611291565b6104a0565b005b6102686104b2565b60405161027591906112cb565b60405180910390f35b6102866104da565b6040516102939190611039565b60405180910390f35b6102b660048036038101906102b19190611345565b61056a565b005b6102d260048036038101906102cd91906110ee565b610712565b6040516102df9190611146565b60405180910390f35b61030260048036038101906102fd91906113a2565b610734565b60405161030f919061116e565b60405180910390f35b610332600480360381019061032d919061123c565b6107b6565b005b6060600380546103439061140d565b80601f016020809104026020016040519081016040528092919081815260200182805461036f9061140d565b80156103ba5780601f10610391576101008083540402835291602001916103ba565b820191905f5260205f20905b81548152906001019060200180831161039d57829003601f168201915b5050505050905090565b5f806103ce61083a565b90506103db818585610841565b600191505092915050565b5f600254905090565b5f806103f961083a565b9050610406858285610853565b6104118585856108e5565b60019150509392505050565b60065481565b5f6012905090565b5f805f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20549050919050565b6104786109d5565b6104815f610a5c565b565b6007602052805f5260405f205f915054906101000a900460ff1681565b6104a86109d5565b8060068190555050565b5f60055f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b6060600480546104e99061140d565b80601f01602080910402602001604051908101604052809291908181526020018280546105159061140d565b80156105605780601f1061053757610100808354040283529160200191610560565b820191905f5260205f20905b81548152906001019060200180831161054357829003601f168201915b5050505050905090565b60075f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f9054906101000a900460ff16156105f4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105eb90611487565b60405180910390fd5b5f338460405160200161060892919061150a565b60405160208183030381529060405280519060200120905061066d8383808060200260200160405190810160405280939291908181526020018383602002808284375f81840152601f19601f8201169050808301925050505050505060065483610b1f565b6106ac576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106a39061157f565b60405180910390fd5b600160075f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f6101000a81548160ff02191690831515021790555061070c3033866108e5565b50505050565b5f8061071c61083a565b90506107298185856108e5565b600191505092915050565b5f60015f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054905092915050565b6107be6109d5565b5f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff160361082e575f6040517f1e4fbdf700000000000000000000000000000000000000000000000000000000815260040161082591906112cb565b60405180910390fd5b61083781610a5c565b50565b5f33905090565b61084e8383836001610b35565b505050565b5f61085e8484610734565b90507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff81146108df57818110156108d0578281836040517ffb8f41b20000000000000000000000000000000000000000000000000000000081526004016108c79392919061159d565b60405180910390fd5b6108de84848484035f610b35565b5b50505050565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610955575f6040517f96c6fd1e00000000000000000000000000000000000000000000000000000000815260040161094c91906112cb565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16036109c5575f6040517fec442f050000000000000000000000000000000000000000000000000000000081526004016109bc91906112cb565b60405180910390fd5b6109d0838383610d04565b505050565b6109dd61083a565b73ffffffffffffffffffffffffffffffffffffffff166109fb6104b2565b73ffffffffffffffffffffffffffffffffffffffff1614610a5a57610a1e61083a565b6040517f118cdaa7000000000000000000000000000000000000000000000000000000008152600401610a5191906112cb565b60405180910390fd5b565b5f60055f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1690508160055f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b5f82610b2b8584610f1d565b1490509392505050565b5f73ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1603610ba5575f6040517fe602df05000000000000000000000000000000000000000000000000000000008152600401610b9c91906112cb565b60405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610c15575f6040517f94280d62000000000000000000000000000000000000000000000000000000008152600401610c0c91906112cb565b60405180910390fd5b8160015f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20819055508015610cfe578273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92584604051610cf5919061116e565b60405180910390a35b50505050565b5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610d54578060025f828254610d4891906115ff565b92505081905550610e22565b5f805f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054905081811015610ddd578381836040517fe450d38c000000000000000000000000000000000000000000000000000000008152600401610dd49392919061159d565b60405180910390fd5b8181035f808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2081905550505b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610e69578060025f8282540392505081905550610eb3565b805f808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f82825401925050819055505b8173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051610f10919061116e565b60405180910390a3505050565b5f808290505f5b8451811015610f6657610f5182868381518110610f4457610f43611632565b5b6020026020010151610f71565b91508080610f5e9061165f565b915050610f24565b508091505092915050565b5f818310610f8857610f838284610f9b565b610f93565b610f928383610f9b565b5b905092915050565b5f825f528160205260405f20905092915050565b5f81519050919050565b5f82825260208201905092915050565b5f5b83811015610fe6578082015181840152602081019050610fcb565b5f8484015250505050565b5f601f19601f8301169050919050565b5f61100b82610faf565b6110158185610fb9565b9350611025818560208601610fc9565b61102e81610ff1565b840191505092915050565b5f6020820190508181035f8301526110518184611001565b905092915050565b5f80fd5b5f80fd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f61108a82611061565b9050919050565b61109a81611080565b81146110a4575f80fd5b50565b5f813590506110b581611091565b92915050565b5f819050919050565b6110cd816110bb565b81146110d7575f80fd5b50565b5f813590506110e8816110c4565b92915050565b5f806040838503121561110457611103611059565b5b5f611111858286016110a7565b9250506020611122858286016110da565b9150509250929050565b5f8115159050919050565b6111408161112c565b82525050565b5f6020820190506111595f830184611137565b92915050565b611168816110bb565b82525050565b5f6020820190506111815f83018461115f565b92915050565b5f805f6060848603121561119e5761119d611059565b5b5f6111ab868287016110a7565b93505060206111bc868287016110a7565b92505060406111cd868287016110da565b9150509250925092565b5f819050919050565b6111e9816111d7565b82525050565b5f6020820190506112025f8301846111e0565b92915050565b5f60ff82169050919050565b61121d81611208565b82525050565b5f6020820190506112365f830184611214565b92915050565b5f6020828403121561125157611250611059565b5b5f61125e848285016110a7565b91505092915050565b611270816111d7565b811461127a575f80fd5b50565b5f8135905061128b81611267565b92915050565b5f602082840312156112a6576112a5611059565b5b5f6112b38482850161127d565b91505092915050565b6112c581611080565b82525050565b5f6020820190506112de5f8301846112bc565b92915050565b5f80fd5b5f80fd5b5f80fd5b5f8083601f840112611305576113046112e4565b5b8235905067ffffffffffffffff811115611322576113216112e8565b5b60208301915083602082028301111561133e5761133d6112ec565b5b9250929050565b5f805f6040848603121561135c5761135b611059565b5b5f611369868287016110da565b935050602084013567ffffffffffffffff81111561138a5761138961105d565b5b611396868287016112f0565b92509250509250925092565b5f80604083850312156113b8576113b7611059565b5b5f6113c5858286016110a7565b92505060206113d6858286016110a7565b9150509250929050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f600282049050600182168061142457607f821691505b602082108103611437576114366113e0565b5b50919050565b7f546f6b656e7320616c726561647920636c61696d6564000000000000000000005f82015250565b5f611471601683610fb9565b915061147c8261143d565b602082019050919050565b5f6020820190508181035f83015261149e81611465565b9050919050565b5f8160601b9050919050565b5f6114bb826114a5565b9050919050565b5f6114cc826114b1565b9050919050565b6114e46114df82611080565b6114c2565b82525050565b5f819050919050565b6115046114ff826110bb565b6114ea565b82525050565b5f61151582856114d3565b60148201915061152582846114f3565b6020820191508190509392505050565b7f496e76616c6964204d65726b6c652050726f6f660000000000000000000000005f82015250565b5f611569601483610fb9565b915061157482611535565b602082019050919050565b5f6020820190508181035f8301526115968161155d565b9050919050565b5f6060820190506115b05f8301866112bc565b6115bd602083018561115f565b6115ca604083018461115f565b949350505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f611609826110bb565b9150611614836110bb565b925082820190508082111561162c5761162b6115d2565b5b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f611669826110bb565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff820361169b5761169a6115d2565b5b60018201905091905056fea26469706673582212202ec500bf1655256463d5968b2ce5fc5f28830271c92f1fd3a7c62a36dd42f69e64736f6c63430008140033
